{% extends "_layouts/cp" %}
{% set title = "üìö Manage Books" %}

{% block content %}
	<h2>üìö Manage Books</h2>

	{% set section = craft.app.sections.getSectionByHandle('books') %}
	{% set entryType = section.entryTypes[0] ?? null %}

	<h3>Add New Book</h3>

	<style>
		form.book-form {
			max-width: 500px;
			background: #f8f9fa;
			padding: 20px;
			border-radius: 8px;
			border: 1px solid #dee2e6;
			margin-bottom: 30px;
		}
		.form-group {
			margin-bottom: 15px;
		}
		.form-group label {
			display: block;
			font-weight: bold;
			margin-bottom: 5px;
		}
		.form-group input[type="text"],
		.form-group input[type="checkbox"] {
			width: 100%;
			padding: 8px;
			box-sizing: border-box;
		}
		.btn {
			background: #007bff;
			color: white;
			border: none;
			padding: 10px 15px;
			border-radius: 5px;
			cursor: pointer;
		}
		.btn:hover {
			background: #0056b3;
		}
	</style>
	<form class="book-form" method="POST" accept-charset="UTF-8" enctype="multipart/form-data">
		{{ csrfInput() }}
		<input type="hidden" name="action" value="entries/save-entry">
		<input type="hidden" name="sectionId" value="{{ section.id }}">
		<input type="hidden" name="entryTypeId" value="{{ entryType.id }}">
		<input type="hidden" name="siteId" value="{{ currentSite.id }}">
		<input type="hidden" name="enabled" value="1">
		<input type="hidden" name="redirect" value="{{ 'librarymanager/books?success=1' | hash }}">

		<div class="form-group">
			<label>Title:</label>
			<input type="text" name="title" required>
		</div>

		<div class="form-group">
			<label>Book Title:</label>
			<input type="text" name="fields[bookTitle]" required>
		</div>

		<div class="form-group">
			<label>Author:</label>
			<input type="text" name="fields[bookAuthor]" required>
		</div>

		<div class="form-group">
			<label>ISBN:</label>
			<input type="text" name="fields[isbn]" required>
		</div>

		<div class="">
			<label><input type="checkbox" name="fields[isBorrowed]" value="1">
				Is Borrowed</label>
		</div>

		<button type="submit" class="btn">‚ûï Add Book</button>
	</form>

	<hr>

	<h3>üìã List of Books</h3>

	{% set books = craft.entries.section('books').all() %}

	<table border="1" cellpadding="8">
		<thead>
			<tr>
				<th>Title</th>
				<th>Book Title</th>
				<th>Author</th>
				<th>ISBN</th>
				<th>Status</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody>
			{% for book in books %}
				<tr>
					<td>{{ book.title }}</td>
					<td>{{ book.bookTitle }}</td>
					<td>{{ book.bookAuthor }}</td>
					<td>{{ book.isbn }}</td>
					<td>
						{% if book.isBorrowed %}
							<span style="color:red;">Borrowed</span>
						{% else %}
							<span style="color:green;">Available</span>
						{% endif %}
					</td>
					<td>
						<!-- Delete Form -->
						<form method="POST" style="display:inline;">
							{{ csrfInput() }}
							<input type="hidden" name="action" value="elements/delete">
							<input type="hidden" name="elementId" value="{{ book.id }}">
							<button type="submit" onclick="return confirm('Delete this book?')">üóë Delete</button>
						</form>

						<!-- Edit Toggle Button -->
						<button onclick="toggleEdit('{{ book.id }}')">‚úèÔ∏è Edit</button>
					</td>
				</tr>

				<!-- Edit Form Row (Hidden by default) -->
				<tr id="edit-form-{{ book.id }}" style="display:none;">
					<td colspan="6">
						<form method="POST" style="background:#f1f1f1; padding:10px; border:1px solid #ccc;">
							{{ csrfInput() }}
							<input type="hidden" name="action" value="entries/save-entry">
							<input type="hidden" name="sectionId" value="{{ section.id }}">
							<input type="hidden" name="entryId" value="{{ book.id }}">
							<input type="hidden" name="entryTypeId" value="{{ book.type.id }}">
							<input type="hidden" name="siteId" value="{{ currentSite.id }}">
							<input type="hidden" name="enabled" value="1">
							<input type="hidden" name="redirect" value="{{ 'librarymanager/books?success=1' | hash }}">

							<label>Title:</label>
							<input type="text" name="title" value="{{ book.title }}" required><br>

							<label>Book Title:</label>
							<input type="text" name="fields[bookTitle]" value="{{ book.bookTitle }}" required><br>

							<label>Author:</label>
							<input type="text" name="fields[bookAuthor]" value="{{ book.bookAuthor }}" required><br>

							<label>ISBN:</label>
							<input type="text" name="fields[isbn]" value="{{ book.isbn }}" required><br>

							<label>Is Borrowed:</label>
							<input type="hidden" name="fields[isBorrowed]" value="0">
							<input type="checkbox" name="fields[isBorrowed]" value="1" {% if book.isBorrowed %} checked {% endif %}>

							<button type="submit">üíæ Save Changes</button>
						</form>
					</td>
				</tr>
			{% else %}
				<tr>
					<td colspan="6">No books found.</td>
				</tr>
			{% endfor %}

		</tbody>
	</table>
	<script>
		function toggleEdit(id) {
let row = document.getElementById("edit-form-" + id);
row.style.display = row.style.display === "none" ? "table-row" : "none";
}
	</script>
{% endblock %}
