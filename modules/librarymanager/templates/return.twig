{% extends "_layouts/cp" %}

{% set title = "ðŸ“¤ Return Book" %}

{% block content %}
	<h2>ðŸ“¤ Return Book</h2>

	{# Only show borrowRecords where returnDate is empty (not returned) #}
	{% set borrowEntries = craft.entries.section('borrowRecords').returnDate('').all() %}

	{% if craft.app.request.getParam('success') %}
		<p style="color:green;">âœ… Book marked as returned!</p>
	{% endif %}

	{% if borrowEntries %}
		<table border="1">
			<tr>
				<th>Customer</th>
				<th>Book</th>
				<th>Borrow Date</th>
				<th>Return</th>
			</tr>
			{% for entry in borrowEntries %}
				{% set book = entry.borrowedBook.one() %}
				{% set borrower = entry.borrower.one() %}

				<tr>
					<td>{{ borrower ? borrower.title : 'Unknown' }}</td>
					<td>{{ book ? (book.bookTitle ?? book.title) : 'Unknown' }}</td>
					<td>{{ entry.borrowDate|date('Y-m-d') }}</td>
					<td>
						{% if book and borrower %}
							<form method="POST" action="{{ url('librarymanager/mark-returned') }}">
								{{ csrfInput() }}
								<input type="hidden" name="elementId" value="{{ entry.id }}">
								<input type="hidden" name="returnDate" value="{{ now|date('Y-m-d H:i:s') }}">
								<input type="hidden" name="redirect" value="{{ 'librarymanager/return?success=1' | hash }}">
								<button type="submit">Mark Returned</button>
							</form>
						{% else %}
							<span style="color: red;">âš  Invalid Borrow Record</span>
						{% endif %}
					</td>
				</tr>

			{% endfor %}
		</table>
	{% else %}
		<p>No borrowed books.</p>
	{% endif %}

	<hr>

	{# Optional: Show all borrow history #}
	<h3>ðŸ“‹ Borrow History</h3>
	{% set allBorrowRecords = craft.entries.section('borrowRecords').orderBy('dateCreated desc').all() %}
	<table border="1">
		<tr>
			<th>Customer</th>
			<th>Book</th>
			<th>Borrow Date</th>
			<th>Return Date</th>
		</tr>
		{% for entry in allBorrowRecords %}
			{% set borrower = entry.borrower.one() %}
			{% set book = entry.borrowedBook.one() %}
			<tr>
				<td>{{ borrower ? borrower.title : 'Unknown' }}</td>
				<td>{{ book ? (book.bookTitle ?? book.title) : 'Unknown' }}</td>
				<td>{{ entry.borrowDate|date('Y-m-d') }}</td>
				<td>
					{% if entry.returnDate %}
						{{ entry.returnDate|date('Y-m-d') }}
					{% else %}
						<span style="color:red;">Not Returned</span>
					{% endif %}
				</td>
			</tr>
			{# <pre style="color: red; background: #fffbe6; border: 1px solid #f5c542; padding: 8px;">
																					    Fields for this entry:
																					    {{ dump(entry.getFieldValues()) }}
																					    </pre> #}
		{% endfor %}
	</table>
{% endblock %}
